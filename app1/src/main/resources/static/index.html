<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>SSO 1</title>
<meta name="description" content="" />
<meta name="viewport" content="width=device-width" />
<base href="/" />
<!-- <link rel="stylesheet" type="text/css"  href="/webjars/bootstrap/css/bootstrap.min.css" /> -->
    <!-- Bootstrap 4 CSS. This is for the alpha 3 release of Bootstrap 4. This should be updated when Bootstrap 4 is officially released. -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/css/bootstrap.min.css" integrity="sha384-MIwDKRSSImVFAZCVLtU0LMDdON6KVCrZHyVQQj6e8wIEJkW4tvwqXrbMIya1vriY" crossorigin="anonymous">
      
    <!-- Custom CSS: You can use this stylesheet to override any Bootstrap styles and/or apply your own styles -->
    <link href="css/custom.css" rel="stylesheet">
    
    <!-- For icons -->
    <link href="css/font-awesome-4.6.3/css/font-awesome.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.css">
    
    <link href="css/custom.css" rel="stylesheet">
    
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript"  src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.js"></script>
</head>
<body>
    <nav id="topNav" class="navbar navbar-full fixed-top navbar-dark bg-inverse m-b-1">
    		<span class="navbar-brand"><i class="fa fa-paper-plane"></i></span><span class="navbar-brand">SSO1</span>
    		<div class="navbar-brand pull-right authenticated" style="display: none">Logged in as: <strong><span id="username"></span></strong>&nbsp;<span><button onClick="logout()" class="btn btn-secondary">Logout</button></span>
    		</div>
    </nav>
    
<div class="container-fluid">
		<!-- Left Column -->
		<div class="col-sm-6">
			<div class="container bg-info">
				<h2 align="center" class="text-white custom-title">SSO Client 1</h2>
			</div>
			<div class="unauthenticated">
				<p>
				Welcome to the <strong>Eclipse OAuth SSO Demo</strong>.
				</p>
		    </div>
			<div class="authenticated" style="display: none">
		        <p>
		        Hello <strong><span id="user"></span></strong>, this is the <strong>Eclipse OAuth SSO Demo</strong>.
		        </p>
		    </div>
		    <div class="container unauthenticated">
    			<div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-sign-in" aria-hidden="true"></i> 
						Log In
					</h5>
				</div>
				<div class="card-block">
        			  <a href="/login" class="btn btn-outline-success">Login with Eclipse</a>
				</div>
			</div>
    			</div>
    			<div class="container authenticated" style="display: none">
    			<div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-user" aria-hidden="true"></i> 
						User Details
					</h5>
				</div>
				
				<div class="card-block">
					<p>
					The details below are retrieved from the <span class="alert-warning"><strong>/oauth/me</strong></span> REST endpoint invoked using the OAuth2 access token.
					</p>
			        <table class="table">
			          <tbody>
			            <tr>
			              <td>Person name</td>
			              <td class="bg-info"><span id="personName"></span></td>
			              <td>Person Id</td>
			              <td class="bg-info"><span id="personId"></span></td>
			            </tr>
			            <tr>
			              <td>Profile</td>
			              <td class="bg-info" colspan="3"><span id="profile"></span></td>
			            </tr>
			            <tr>
			              <td>Mobile</td>
			              <td class="bg-info" colspan="3"><span id="mobile"></span></td>
			            </tr>
			            <tr>
			              <td>Email</td>
			              <td class="bg-info" colspan="3"><span id="email"></span></td>
			            </tr>
			            <tr>
			              <td>Role</td>
			              <td class="bg-info" colspan="3"><span id="role"></span></td>
			            </tr>
			            <tr>
			              <td>Team name</td>
			              <td class="bg-info"><span id="teamName"></span></td>
			              <td>Team Id</td>
			              <td class="bg-info"><span id="teamId"></span></td>
			            </tr>
			            <tr>
			              <td>Team region</td>
			              <td class="bg-info"><span id="region"></span></td>
			              <td>Region code</td>
			              <td class="bg-info"><span id="regionCode"></span></td>
			            </tr>
			          </tbody>
			        </table>
			        <div>
			               <a href="https://olm-custombuild-ecl.olmeservices.co.uk/eclipse" class="btn btn-outline-primary" target="_blank">Launch Eclipse (Alpha)</a>
			               <a href="http://localhost:8080/eclipse" class="btn btn-outline-secondary" target="_blank">Launch Eclipse (Local)</a>
			               <a href="http://localhost:8082/login" class="btn btn-outline-success" target="_blank">Launch SSO2</a>
			        </div>
			        <p>
			          <div class="alert alert-warning">
			            <strong>NOTE:</strong> Please be aware, the <strong>Eclipse (Local)</strong> and <strong>SSO2</strong> buttons require these apps to be running locally.
			          </div>
			        </p>
				</div>
			</div>

    			<div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-ticket" aria-hidden="true"></i> 
						Token Details
					</h5>
				</div>
				<div class="card-block">
					<p>
					The details below are included in the OAuth2 access token itself.
					</p>
			        <table class="table">
			          <tbody>
			            <tr>
			              <td>Expiry</td>
			              <td class="bg-info" colspan="2"><span id="tokenExpiry"></span></td>
			            </tr>
			            <tr>
			              <td>Username</td>
			              <td class="bg-info" colspan="2"><span id="username_details"></span></td>
			            </tr>
			            <tr>
			              <td>User Id</td>
			              <td class="bg-info" colspan="2"><span id="userId"></span></td>
			            </tr>
			            <tr>
			              <td>Profile Id</td>
			              <td class="bg-info" colspan="2"><span id="profileId"></span></td>
			            </tr>
			            <tr>
			              <td>Authorities</td>
			              <td class="bg-info" colspan="2"><span id="authorities"></span></td>
			            </tr>
			            <tr>
			              <td>Scopes</td>
			              <td class="bg-info" colspan="2"><span id="tokenScopes"></span></td>
			            </tr>
			            <tr>
			              <td>Token Id</td>
			              <td class="bg-info" colspan="2"><span id="tokenId"></span></td>
			            </tr>
			            <tr>
			              <td>Refresh token expiry</td>
			              <td class="bg-info" colspan="2"><span id="refreshTokenExpiry"></span></td>
			            </tr>
			            <tr>
			              <td><button onClick="refresh()" class="btn btn-outline-primary">Refresh</button></td>
			              <td colspan="2"><span>Access tokens are only refreshed when they have expired. Using any API (Person search or Case note) will automatically refresh an expired token.</span></td>
			            </tr>
			            <tr>
			              <td class="alert-warning"><button onClick="revokeToken()" class="btn btn-outline-danger">Revoke token</button></td>
			              <td class="alert-warning" colspan="2"><span>This operation does not currently work and requires more development.</span></td>
			            </tr>
			          </tbody>
			        </table>
				</div>
			</div>

    			<div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-search" aria-hidden="true"></i> 
						Eclipse Person Search
					</h5>
				</div>
				<div class="card-block">
					<div class="input-group mb-3 input-prepend-append">
					  <div class="input-group-prepend">
					    <span class="input-group-text" id="inputGroup-sizing-default">Search</span>
					  </div>
			            <input type="text" class="form-control" id="personSearch" placeholder="Enter search term" onkeypress="getPersons()"/> 
					 </div>
  					 <br/>
  					 <div class="alert alert-danger person-search-error" style="display: none">
					<i class="fa fa-exclamation-circle" aria-hidden="true"></i> There was a problem with the person search.
  					 </div>
			          <table id="personsTable" data-toggle="table" class="table table-striped table-hover">
			            <caption>Person details from Eclipse.</caption>
			            <thead class="thead-light">
			              <tr>
			                <th data-field="id" scope="col">Identifier</th>
			                <th data-field="name" scope="col">Name</th>
			                <th data-field="age" scope="col">Age</th>
			              </tr>
			            </thead>
			          </table>
				</div>
		  	</div>
		  	
		    <div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-sticky-note" aria-hidden="true"></i> 
						Case Note
					</h5>
				</div>
				<div class="card-block">
					<p>
					Click on a row in the person search results to get their latest case note.
					</p>
					<div class="casenote-context casenote-selected" style="display: none">
					<p>
					Case note details for: <strong><span id="caseNoteName"></span></strong>
					</p>
					</div>
					<div class="casenote-context casenote-found" style="display: none">
			        <table class="table">
			          <tbody>
			            <tr>
			              <td>Event date</td>
			              <td class="bg-info" colspan="2"><span id="event-date"></span></td>
			            </tr>
			            <tr>
			              <td>Type</td>
			              <td class="bg-info" colspan="2"><span id="event-type"></span></td>
			            </tr>
			            <tr>
			              <td>Subtype</td>
			              <td class="bg-info" colspan="2"><span id="event-subtype"></span></td>
			            </tr>
			            <tr>
			              <td>Practitioner</td>
			              <td class="bg-info" colspan="2"><span id="event-practitioner"></span></td>
			            </tr>
			            <tr>
			              <td>Event</td>
			              <td class="bg-info" colspan="2"><span id="event-details"></span></td>
			            </tr>
			          </tbody>
			        </table>	
					</div>
					<div class="casenote-context casenote-not-found alert alert-info" style="display: none">
					  <i class="fa fa-info-circle" aria-hidden="true"></i> No case note details found.
					</div>
					<div class="casenote-context casenote-secured alert alert-warning" style="display: none">
					  <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> These case note details are secured.
					</div>
					<div class="casenote-context casenote-error alert alert-danger" style="display: none">
					  <i class="fa fa-exclamation-circle" aria-hidden="true"></i> There was a problem getting the case note.
					</div>
				</div>
		  	</div>
		  	
			</div>
		</div>
			  <!-- Right Column -->
	  <div class="col-sm-6">
	  	<div class="container authenticated" style="display: none">
	      	<div class="card">
				<div class="card-header p-b-0">
					<h5 class="card-title">
						<i class="fa fa-key" aria-hidden="true"></i> 
						Permissions
					</h5>
				</div>
				<div class="card-block">
					<div class="table-wrapper-scroll-y ">
					<p>
					These are the permissions assigned to the authorities included in the access token, and are fetched from the <span class="alert-warning"><strong>/oauth/aggregatedPermission</strong></span> REST endpoint invoked using the OAuth2 access token.
					</p>
					 <div class="alert alert-danger permissions-error" style="display: none">
					 <i class="fa fa-exclamation-circle" aria-hidden="true"></i> There was a problem with retrieving permissions.
  					 </div>
					
			          <table id="permissionsTable" 
			             data-toggle="table" 
						  data-search="true"
			               data-show-pagination-switch="true"
						  data-pagination="true"
						  data-id-field="id"
						  data-page-list="[10, 25, 50, 100, all]"
						  data-show-footer="true"
			             class="table table-striped table-hover">
			            <caption>Permissions from Eclipse.</caption>
			            <thead class="thead-light">
			              <tr>
			                <th data-field="domain" scope="col">Domain</th>
			                <th data-field="permissions" scope="col">Permissions</th>
			              </tr>
			            </thead>
			          </table>
			       </div>
				</div>
		  	</div>
		    </div>
	    </div>
	  </div>
</div>

    <script type="text/javascript" src="/webjars/js-cookie/js.cookie.js"></script>
    <script type="text/javascript">
          $.ajaxSetup({
                beforeSend : function(xhr, settings) {
                  if (settings.type == 'POST' || settings.type == 'PUT'
                      || settings.type == 'DELETE') {
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/
                        .test(settings.url))) {
                      // Only send the token to relative URLs i.e. locally.
                      xhr.setRequestHeader("X-XSRF-TOKEN",
                          Cookies.get('XSRF-TOKEN'));
                    }
                  }
                }
              })
              
          var $personsTable = $("#personsTable")
          var $permissionsTable = $("#permissionsTable")
          
          var clearUserDetails = function() {
         	  $("#user").html("");
         	  $("#username").html("");
         	  $("#username_details").html("");
              $("#authorities").html("");
              $("#teamName").html("");
              $("#teamId").html("");
              $("#region").html("");
              $("#regionCode").html("");
              $("#profile").html("");
              $("#mobile").html("");
              $("#email").html("");
              $("#role").html("");
              $("#userId").html("");
              $("#profileId").html("");
              $("#personName").html("");
              $("#personId").html("");
              $("#tokenExpiry").html("");
              $("#refreshTokenExpiry").html("");
              $("#tokenScopes").html("");
              $("#tokenId").html("");
          }
          var getUser = function() {
        	     clearUserDetails();
        	     var authenticated = false;
              $.get("/user", function(data) {
	              $("#user").html(data.subject_name);
    		          $("#username").html(data.username);
    		          $("#username_details").html(data.username);
        		      var authorities = [];
            		  $.each(data.authorities, function(index,value) {
            	 	   authorities.push(value.authority);
              	  });
               	  $("#authorities").html(authorities.join(', '));
              	  $("#teamName").html(data.team_name);
              	  $("#teamId").html(data.team_id);
              	  $("#region").html(data.team_region_name);
              	  $("#regionCode").html(data.team_region_code);
              	  $("#profile").html(data.profile_name);
              	  $("#email").html(data.email);
              	  $("#mobile").html(data.phone);
              	  $("#role").html(data.role_name);
              	  $("#userId").html(data.user_id);
              	  $("#profileId").html(data.profile_id);
              	  $("#personName").html(data.subject_name);
              	  $("#personId").html(data.subject_id);
              	  var expiryDate = new Date(data.expiration);
              	  $("#tokenExpiry").html( expiryDate.toLocaleDateString() + " " + expiryDate.toLocaleTimeString());
              	  var refreshExpiryDate = new Date(data.refreshTokenExpiry);
              	  $("#refreshTokenExpiry").html( refreshExpiryDate.toLocaleDateString() + " " + refreshExpiryDate.toLocaleTimeString());
              	  $("#tokenScopes").html(data.scopes.join(', '));
              	  $("#tokenId").html(data.jti);
              	  $("#tokenId").data("bearer", data.token);
              	  console.log("Refresh token = " + data.refreshToken)
              	  if (data.refreshToken !== "NO_REFRESH_TOKEN") {
                    $("#tokenId").data("refresh", data.refreshToken);
              	  }
              	  $(".unauthenticated").hide();
              	  $(".authenticated").show();
                  authenticated = true;
              });
              return authenticated;
          }
          getUser();
          var revokeToken = function() {
        	    var token = $("#token").data("bearer");
        	    console.log('Revoking token ' + token);
        	    $.ajax({
        	    	  url: "/revoke",
        	    	  type:'DELETE',
        	    	  success: function(result) {
        	    		  console.log('Token revoked.');
        	    	  },
        	    	  error: function(result) {
        	    		  console.log('Failed to revoke token.');
        	    	  }
        	    })
          }
          var revokeTokenEclipse_NotWorking = function() {
      	    var token = $("#token").data("bearer");
      	    console.log('Revoking token ' + token);
      	    $.ajax({
      	    	  url: "http://localhost:8080/eclipse/oauth/token",
      	    	  type:'DELETE',
      	    	  headers: {
      	    		  "Authorization":"Bearer " + token
      	    	  },
      	    	   xhrFields: {
      	    		     withCredentials: true
      	    	   },
      	      crossDomain: true,
      	    	  success: function(result) {
      	    		  console.log('Token revoked.');
      	    	  },
      	    	  error: function(result) {
      	    		  console.log('Failed to revoke token.');
      	    	  }
      	    })
        }
          var getPermissions = function() {
              $(".permissions-error").hide();
        	    $.get("/permissions", function(data) {
        	    		var tableData = []
        	    		if (data && data.length > 0) {
        	    			data.forEach(function(val) {
        	    			  tableData.push({
        	    				  'domain': val.domain,
        	    				  'permissions': val.permissions.join(', ')
        	    			  })
        	    			});
        	    		} 
        	    		$permissionsTable.bootstrapTable('load',tableData);
        	    }).fail(function() {
	                  $(".permissions-error").show();
	          		  $permissionsTable.bootstrapTable('load',[]);
        	    });
          }
	      getPermissions();
	      
	      var getPersons = function() {
	    	  	  var searchTerm = $("#personSearch").val();
	    	  	  if (searchTerm && searchTerm.length > 1) {
	              $(".person-search-error").hide();
	          	  $.get("/person/"+searchTerm, function(data) {
	          		  var tableData = [];
	          		  if (data && data.length > 0) {
		          		  data.forEach(function(value) {
		          			let age;
		          			if (value.age < 0) {
		          				age = "Unknown";
		          			} else {
		          				age = value.age;
		          			}
		          			tableData.push({
		          				'id': value.identifier,
		          				'name': value.name,
		          				'age': age,
		          				'_data': ({
		          					'id': value.id,
		          					'name': value.name
		          				})
		          			})
		          		  });
	          		   } 
	          		 $personsTable.bootstrapTable('load', tableData)
	          	  }).fail(function() {
	                  $(".person-search-error").show();
	          		  $personsTable.bootstrapTable('load',[]);
	          	  });
	    	  	  	}
      	  }

	      
	      var getPersonCaseNote = function(id, name) {
          	$(".casenote-context").hide();
            	$(".casenote-selected").show();
            	$("#caseNoteName").html(name);
            	$.get("/caseNoteEntry/"+id, function(data) {
            	  if (data) {
            		if (data.secured) {
                        $(".casenote-secured").show();
            		} else {
	                if (data.eventDate) {
	                  var eventDate = new Date(data.eventDate);
	                  $("#event-date").html(eventDate.toLocaleDateString());
	                } else {
	                  $("#event-date").html("");
	                }
	                $("#event-type").html(data.entryType);
	                $("#event-subtype").html(data.entrySubtype);
	                $("#event-practitioner").html(data.practitioner);
	                $("#event-details").html(data.eventDetails);
	            	    $(".casenote-found").show();
            		}
            	  } else {
                $(".casenote-not-found").show();
            	  }
            	}).fail(function(xhr, statusText, error){
              $(".casenote-error").show();
            	})
	      }

	      $personsTable.on('click-row.bs.table', function(e, row, $element, field) {
	    	    var id = $element.data("id");
	    	    var name = $element.data("name");
	    	    getPersonCaseNote(id, name);
	      })

	      var logout = function() {
              $.post("/logout", function() {
                $("#user").html('');
                $(".unauthenticated").show();
                $(".authenticated").hide();
              });
              return true;
            }
          var refresh = function() {
        	   $.ajax({
        			url:"/refresh",
        	        type: 'PUT',
        	        success: function(result) {
        		       getUser();
        		       getPermissions();
        	        }
        	   });
        	   return true;
          }
        </script>
</body>
</html>